<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline</title>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.29.1.min.js" charset="utf-8"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="../css/style.css">

    <style>
        div.container {
            height: 500px;
            max-width: 100%;
        }
    </style>
</head>
<body>
    
    <div id="container", class="container"></div>
    <input id= "author_input" type= "text" placeholder= "Last name, first name", list = 'author_list' style="width: 600px;">
    <datalist id = "author_list"></datalist>

    <script>
        d3.csv('/csv/processed_data_timeline.csv', function(err, rows) {
            function unpack(rows, key) {
                return rows.map(function(row) {return row[key];}); 
            }
            let origin = unpack(rows, 'Origin'),
                title = unpack(rows, 'Title'),
                authors = unpack(rows, 'Author'),
                recipient = unpack(rows, 'Recipient')
                lat = unpack(rows, 'start_lat'),
                long = unpack(rows, 'start_long'),
                years = unpack(rows, 'Year'),
                month = unpack(rows, 'Month'),
                day = unpack(rows, 'Day'),
                color = unpack(rows, 'Color'),
                seasons = unpack(rows, 'Season')
                date = unpack(rows, 'Date Created')

            
            
            let minYear = Math.min.apply(null, years),
                maxYear = Math.max.apply(null, years);
            let uniqueYears = [];
            for (let i = minYear; i <= maxYear; i++) {
                uniqueYears.push(i)
            }
            let uniqueMonths = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']

            let data = [];

            let uniqueAuthor = [];
            for (let i = 0; i < authors.length; i++) {
                if (!uniqueAuthor.includes(authors[i])) {
                    uniqueAuthor.push(authors[i])
                }
            }
            let list = document.getElementById('author_list')
            uniqueAuthor.forEach(function(item) {
                let option = document.createElement('option');
                option.value = item;
                list.appendChild(option);
            })

            for (let i = 0; i < uniqueAuthor.length; i ++) {
                let x = [],
                    y = [],
                    text = []

                for (let j = 0; j < title.length; j ++) {
                    if (authors[j] == uniqueAuthor[i]) {
                        x.push(years[j])
                        yVal = Number(month[j])
                        if (['January', 'March', 'May', 'July', 'August', 'October', 'December'].includes(month[i])) {
                            yVal += (Number(day[j]) / 32)
                        }
                        else if (['April', 'June', 'September', 'November']){
                            yVal += (Number(day[j]) / 31)
                        }
                        else {
                            if (years[j] % 4 == 0) {
                                yVal += (Number(day[j]) / 30)
                            }
                            else {
                                yVal += (Number(day[j]) / 29)
                            }
                        }
                        y.push(yVal)
                        text.push('Author: ' + uniqueAuthor[i] + '<br>Title: ' + title[j] + '<br>Sent: ' + date[j])
                    }
                }
                data.push({
                    x: x,
                    y: y,
                    mode: 'markers',
                    type: 'scatter',
                    hoverinfo: uniqueAuthor[i], //doesn't actually do anything on its own, but allows for disabling traces by text input
                    name: '',
                    hovertemplate: text,
                    marker: {size: 5}
                })
             }


            let layout = {
                xaxis: {
                    range: [1815, 1925]
                },
                yaxis: {
                    tickmode: "array",
                    tickvals: [1, 2, 3, 4 ,5, 6, 7, 8, 9, 10, 11, 12],
                    ticktext: uniqueMonths
                },
                title:'Timeline',
                showlegend: false,
                paper_bgcolor: '#f9efd7',
                plot_bgcolor: '#f9efd7'
                };

            
            let config = {responsive: true}
            Plotly.newPlot('container', data, layout, config);

            function filter(authorInput) {
                for (let i = 0; i < uniqueAuthor.length; i++) {
                    data[i].visible = "legendonly"
                    if (authorInput == data[i].hoverinfo) {
                        data[i].visible = true
                    }
                    else if (authorInput == '') {
                        data[i].visible = true
                    }
                }
                Plotly.newPlot('container', data, layout, config)
            }

            let authorInput = document.querySelector('#author_input')
            authorInput.addEventListener("input", (event) => {
                if (uniqueAuthor.includes(authorInput.value)) {
                    filter(authorInput.value)
                }
                else {
                    filter('')
                }
            });
        });
    </script>
</body>
</html>