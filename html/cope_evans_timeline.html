<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline</title>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.29.1.min.js" charset="utf-8"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="../css/style.css">

</head>
<body>
    <h1>The Collection Over Time</h1>    
    <p>The following scatterplot represents a timeline of letters in the collection, where the x-axis is the year and the y-axis represents the month and date. The color of each point denotes the author of the letter; however, the number of authors means that many colors are shared between authors. Below the timeline is a textbox for an author's name, which will filter the timeline to only include letters written by this author. Below this are two sliders to define a range of years for filtering. There are also textboxes for year. There is a minumum range of five years.</p>
    <div id="timeline", class="timeline"></div>
    <input id = "begin_year_input" class="year_text" type="text" placeholder="Beginning Year", value="1820">
    <input id = "end_year_input" class="year_text" type="text" placeholder="End Year", value="1920">
    <input id="clear_year" type="button" value="Clear">
    <br>
    <input id= "author_input" class = "author_input" type= "text" placeholder= "Last name, first name", list = 'author_list'>
    <input id="clear_author" type="button" value="Clear">
    <datalist id = "author_list"></datalist>
    

    <div id="year_sliders" class="year_sliders">
        <p>Start Year: <output id="start_year_value"></output></p><input type="range" id="start_year", step="1", min="1820" max="1920" value="1820">

        <p>End Year: <output id="end_year_value"></output></p><input type="range" id="end_year", step="1", min="1820" max="1920" value="1920">
    </div>
    <input type="button" id="slider_reset" value="Reset"></input>
    
    <script>
        d3.csv('/csv/processed_data_timeline.csv', function(err, rows) {
            function unpack(rows, key) {
                return rows.map(function(row) {return row[key];}); 
            }
            let origin = unpack(rows, 'Origin'),
                title = unpack(rows, 'Title'),
                authors = unpack(rows, 'Author'),
                recipient = unpack(rows, 'Recipient')
                lat = unpack(rows, 'start_lat'),
                long = unpack(rows, 'start_long'),
                years = unpack(rows, 'Year'),
                month = unpack(rows, 'Month'),
                day = unpack(rows, 'Day'),
                color = unpack(rows, 'Color'),
                seasons = unpack(rows, 'Season')
                date = unpack(rows, 'Date Created')

            
            
            let minYear = Math.min.apply(null, years),
                maxYear = Math.max.apply(null, years);
            let uniqueYears = [];
            for (let i = minYear; i <= maxYear; i++) {
                uniqueYears.push(i)
            }
            let uniqueMonths = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']

            let data = [];

            let uniqueAuthor = [];
            for (let i = 0; i < authors.length; i++) {
                if (!uniqueAuthor.includes(authors[i])) {
                    uniqueAuthor.push(authors[i])
                }
            }
            let list = document.getElementById('author_list')
            uniqueAuthor.forEach(function(item) {
                let option = document.createElement('option');
                option.value = item;
                list.appendChild(option);
            })

            for (let i = 0; i < uniqueAuthor.length; i ++) {
                let x = [],
                    y = [],
                    text = []

                for (let j = 0; j < title.length; j ++) {
                    if (authors[j] == uniqueAuthor[i]) {
                        x.push(years[j])
                        yVal = Number(month[j])
                        if (['January', 'March', 'May', 'July', 'August', 'October', 'December'].includes(month[i])) {
                            yVal += (Number(day[j]) / 32)
                        }
                        else if (['April', 'June', 'September', 'November'].includes(month[i])){
                            yVal += (Number(day[j]) / 31)
                        }
                        else {
                            if (years[j] % 4 == 0) {
                                yVal += (Number(day[j]) / 30)
                            }
                            else {
                                yVal += (Number(day[j]) / 29)
                            }
                        }
                        y.push(yVal)
                        text.push(uniqueAuthor[i] + '<br>Title: ' + title[j] + '<br>Sent: ' + date[j])
                    }
                }
                data.push({
                    x: x,
                    y: y,
                    mode: 'markers',
                    type: 'scatter',
                    hoverinfo: uniqueAuthor[i], //doesn't actually do anything on its own, but allows for disabling traces by text input
                    name: '',
                    hovertemplate: text,
                    marker: {size: 5}
                })
             }


            let layout = {
                xaxis: {
                    autorange: false,
                    range: [1815, 1925]
                },
                yaxis: {
                    tickmode: "array",
                    tickvals: [1, 2, 3, 4 ,5, 6, 7, 8, 9, 10, 11, 12],
                    ticktext: uniqueMonths
                },
                showlegend: false,
                paper_bgcolor: '#f9efd7',
                plot_bgcolor: '#f9efd7'
                };

            
            let config = {responsive: true}
            Plotly.newPlot('timeline', data, layout, config);

            function filter(authorInput, yearInput) {
                for (let i = 0; i < uniqueAuthor.length; i++) {
                    data[i].visible = "legendonly"
                    if (authorInput == data[i].hoverinfo) {
                        data[i].visible = true
                    }
                    else if (authorInput == '') {
                        data[i].visible = true
                    } 
                }
                layout.xaxis.range = [Number(yearInput[0]), Number(yearInput[1])]
               Plotly.react('timeline', data, layout, config)
            }

            let authorInput = document.querySelector('#author_input'),
                authorClear = document.querySelector('#clear_author')
                yearBegin = document.querySelector('#begin_year_input'),
                yearEnd = document.querySelector('#end_year_input'),
                yearClear = document.querySelector('#clear_year'),
                startYear = document.querySelector('#start_year'),
                endYear = document.querySelector('#end_year'),
                startYearInput = document.querySelector('#start_year_value'),
                endYearInput = document.querySelector('#end_year_value'),
                sliderReset = document.querySelector('#slider_reset')
                


            authorInput.addEventListener("input", (event) => {
                if (uniqueAuthor.includes(authorInput.value)) {
                    filter(authorInput.value, [yearBegin.value, yearEnd.value])
                }
            });

            authorClear.addEventListener("click", (event) => {
                authorInput.value = ''
                filter('', [startYear.value, endYear.value])
            })
            
            yearBegin.addEventListener("input", (event) => {
                if (uniqueYears.includes(Number(yearBegin.value))) {
                    filter(authorInput.value, [yearBegin.value, yearEnd.value])
                }
            })

            yearEnd.addEventListener("input", (event) => {
                if (uniqueYears.includes(Number(yearEnd.value))) {
                    filter(authorInput.value, [yearBegin.value, yearEnd.value])
                }
            })

            yearClear.addEventListener("click", (event) => {
                yearBegin.value = 1820
                yearEnd.value = 1920
                filter(authorInput.value, [1820, 1920])
            })

            startYear.addEventListener("input", (event) => {
                if (startYear.value >= endYear.value - 5) {
                    startYear.value = Number(endYear.value) - 5
                }
                filter(authorInput.value, [startYear.value, endYear.value])
                startYearInput.textContent = startYear.value
            })

            endYear.addEventListener("input", (event) => {
                if (endYear.value <= Number(startYear.value) + 5) {
                    endYear.value = Number(startYear.value) + 5
                }
              filter(authorInput.value, [startYear.value, endYear.value])
              endYearInput.textContent = Number(endYear.value)
            })


            sliderReset.addEventListener("click", (event) => {
                startYear.value = startYearInput.textContent = 1820
                endYear.value = endYearInput.textContent = 1920
                filter(authorInput.value, [1820, 1920])
            })

            startYearInput.textContent = startYear.value
            endYearInput.textContent = endYear.value

        });
    </script>
</body>
</html>